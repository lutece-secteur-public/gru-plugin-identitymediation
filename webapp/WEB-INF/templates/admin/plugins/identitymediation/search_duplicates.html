<#include "utils/functions.ftl" />
<@pageContainer>
  <@pageColumn id="mediation-filter-menu" width="25rem" responsiveMenuSize="xxl" responsiveMenuPlacement="start"
    title="#i18n{identitymediation.search_duplicates.pageTitle}">
    <hr class="d-none d-xxl-block">
    <h2 class="fw-bolder mb-2 mt-xxl-4"><i class="ti ti-user-search"></i> #i18n{identitymediation.search_duplicates.searchTitle}</h2>
    <@tform method='post' name='search_identity' action='jsp/admin/plugins/identitymediation/IdentityDuplicate.jsp?view_searchDuplicates&code=${current_rule_code}'
      id='identitySearch' class='border-bottom pb-3 mt-4'>
      <@formGroup labelKey='#i18n{identitymediation.search_duplicates.first_name}' labelFor='first_name'
        hideLabel=['all'] rows=2>
        <@input type='text' id='first_name' name='first_name' value='${first_name!""}'
          placeHolder='#i18n{identitymediation.search_duplicates.first_name}' size='' />
      </@formGroup>
      <@formGroup labelKey='#i18n{identitymediation.search_duplicates.family_name}' labelFor='family_name'
        hideLabel=['all'] rows=2>
        <@input type='text' id='family_name' name='family_name' value='${family_name!""}'
          placeHolder='#i18n{identitymediation.search_duplicates.family_name}' size='' />
      </@formGroup>
      <@formGroup labelKey='#i18n{identitymediation.search_duplicates.birthdate}' labelFor='birthdate'
        hideLabel=['all'] rows=2>
        <@input type='text' id='birthdate' name='birthdate' value='${birthdate!""}'
          placeHolder='#i18n{identitymediation.search_duplicates.birthdate}' size='' />
      </@formGroup>
      <@formGroup rows=2>
        <@button type='submit' style='w-100' buttonIcon='search' title='#i18n{portal.util.labelSearch}' color='primary'
          size='' />
      </@formGroup>
    </@tform>
    <h2 class="fw-bolder mb-2 mt-4"><i class="ti ti-filters"></i> #i18n{identitymediation.search_duplicates.rulesTitle}</h2>
    <ul class="list-group mt-4">
      <#list duplicate_rule_list as rule>
        <a href="jsp/admin/plugins/identitymediation/IdentityDuplicate.jsp?view_searchDuplicates&code=${rule.code}"
          class="list-group-item list-group-item-action <#if rule.code == current_rule_code>bg-primary-subtle</#if>"
          id="${rule.code}">
          <div class="d-flex justify-content-between align-items-center">
            <span class="my-auto <#if rule.code == current_rule_code>fw-bolder</#if>">${rule.name}</span>
            <div class="d-flex align-items-center">
              <#if rule.duplicateCount?number gt 0>
                <@tag color="danger">${rule.duplicateCount}</@tag>
              <#else>
                <@tag color="success">${rule.duplicateCount}</@tag>
              </#if>
            </div>
          </div>
        </a>
      </#list>
    </ul>
  </@pageColumn>
  <@pageColumn flush=true class="">
    <#list duplicate_rule_list as rule>
      <#if rule.code == current_rule_code>
        <div class="jumbotron jumbotron-fluid d-flex align-items-center justify-content-center text-center bg-secondary pb-5">
          <div class="col-8 mt-5 mb-5 pb-4">
            <@pageColumnBtn class="mb-3 position-absolute start-0 ms-5 mt-4 top-0"
              hideSize="xxl" title="#i18n{identitymediation.search_duplicates.pageTitle}" idPageColumn="mediation-filter-menu" />
            <@tag color="primary" class="mb-3 px-3">${rule.name}</@tag>
            <#assign duplicateCount = rule.duplicateCount />
            <#assign title><strong>${rule.duplicateCount}</strong> <#if rule.duplicateCount?number gt 1>#i18n{identitymediation.choose_duplicate_type.pendingDuplicates}<#else>#i18n{identitymediation.choose_duplicate_type.pendingDuplicate}</#if></#assign>
            <@pageHeader title=title description=rule.description>
            </@pageHeader>
            <@messages infos=infos />
            <@messages errors=errors />
            <@messages warnings=warnings />
          </div>
        </div>
      </#if>
    </#list>
    <div class="container-fluid mt-5 px-5" style="margin-top:-102px !important;">
      <#if service_contract??>
        <@tabs>
          <ul class="nav nav-tabs ps-2" data-bs-toggle="tabs" role="tablist">
            <#assign history_size>Rapprochement <@tag color="success" class="ms-2">${identity_history_date_list?size}</@tag></#assign>
            <#assign duplicate_size>Liste des doublons <@tag color="warning" class="ms-2">${duplicateCount}</@tag></#assign>
            <@tabLink active=true href='#duplicates'>${duplicate_size}</@tabLink>
            <@tabLink href='#history'>${history_size}</@tabLink>
          </ul>
          <div class="tab-content bg-transparent">
            <div class="tab-pane fade active show" role="tabpanel" id="duplicates" aria-labelledby="duplicates-tab">
              <@table headBody=true class="table-hover shadow-none ">
                <@tr>
                  <#assign i=0 />
                  <#list service_contract.attributeDefinitions?filter(a -> a.attributeRight.readable) as readableAttr>
                    <#if i lt 4>
                      <#assign i=i+1 />
                      <@th>${readableAttr.name}</@th>
                    </#if>
                  </#list>
                  <@th>#i18n{identitymediation.search_duplicates.statusColumn}</@th>
                  <@th>#i18n{identitymediation.choose_duplicate_type.actionColumn}</@th>
                </@tr>
                <@tableHeadBodySeparator />
                <#if mediation_identity_list?size gt 0>
                  <#list mediation_identity_list as mediation_identity>
                    <@tr>
                      <#assign i=0 />
                      <#list service_contract.attributeDefinitions?filter(a -> a.attributeRight.readable) as readableAttr>
                        <#list mediation_identity.bestIdentity.attributes?filter(a -> a.key == readableAttr.keyName) as attr>
                          <#if i lt 4>
                            <#assign i=i+1 />
                            <@td>
                              ${attr.value}
                            </@td>
                          </#if>
                        </#list>
                      </#list>
                      <@td>
                        <#if mediation_identity.duplicatesToMergeAttributes??>
                          <#assign duplicatesToMergeAttributesSize = mediation_identity.duplicatesToMergeAttributes?size />
                          <#if duplicatesToMergeAttributesSize gt 1>
                            <@tag color="primary" class="text-uppercase"><strong>${duplicatesToMergeAttributesSize}</strong> #i18n{identitymediation.search_duplicates.status.selection}</@tag>
                          <#elseif  duplicatesToMergeAttributesSize == 1 >
                            <#assign firstKey = mediation_identity.duplicatesToMergeAttributes?keys[0]>
                            <#if firstKey.monParisActive >
                              <@tag color="warning" class="text-uppercase">#i18n{identitymediation.search_duplicates.status.notification}</@tag>
                            <#else>
                              <@tag color="warning" class="text-uppercase">#i18n{identitymediation.search_duplicates.status.merge}</@tag>
                            </#if>
                          <#else>
                            <@tag color="success" class="text-uppercase">#i18n{identitymediation.search_duplicates.status.empty}</@tag>
                          </#if>
                        </#if>
                      </@td>
                      <@td>
                        <#if duplicatesToMergeAttributesSize gt 0>
                          <@aButton
                            href='jsp/admin/plugins/identitymediation/IdentityDuplicate.jsp?view=selectIdentities&cuid=${mediation_identity.suspiciousIdentity.customerId}&rule-code=${current_rule_code}'
                            title='#i18n{identitymediation.duplicate.process}' hideTitle=['all'] buttonIcon='arrow-right'
                            disabled=disabled />
                        </#if>
                      </@td>
                    </@tr>
                  </#list>
                <#else>
                  <@tr>
                    <@td colspan=6>
                      <@empty subtitle=" " />
                    </@td>
                  </@tr>
                </#if>
              </@table>
            </div>
            <div class="tab-pane fade bg-transparent" role="tabpanel" id="history" aria-labelledby="history-tab">     
                <@table headBody=true class="table-hover shadow-none ">
                  <@tr>
                    <@th>#i18n{identitymediation.search_history.dateColumn}</@th>
                    <@th>#i18n{identitymediation.search_history.timeColumn}</@th>
                    <@th>#i18n{identitymediation.search_history.familyNameColumn}</@th>
                    <@th>#i18n{identitymediation.search_history.firstNameColumn}</@th>
                    <@th>#i18n{identitymediation.search_history.authorNameColumn}</@th>
                    <@th>#i18n{identitymediation.search_history.authorTypeColumn}</@th>
                    <@th>#i18n{identitymediation.search_history.attributeChangesColumn}</@th>
                    <@th>#i18n{identitymediation.search_history.statusColumn}</@th>
                  </@tr>
                  <@tableHeadBodySeparator />
                  <#if identity_history_date_list?size == 0>
                    <@tr>
                        <@td colspan=8>
                            <@empty title="#i18n{identitymediation.search_history.noActivity}" subtitle=" " />
                        </@td>
                    </@tr>
                    <#else>
                  <#list identity_history_date_list as modificationDate, innerMap>
                    <#list innerMap as identityDto, attributeChanges>
                      <#assign familyNameAttr = identityDto.attributes?filter(a -> a.key == "family_name")?first />
                      <#assign firstNameAttr = identityDto.attributes?filter(a -> a.key == "first_name")?first />
                      <@tr>
                        <@td>${(modificationDate?number_to_datetime)?string("d MMMM yyyy")}</@td>
                        <@td>${(modificationDate?number_to_datetime)?string("HH:mm")}</@td>
                        <@td>${familyNameAttr.value!"N/A"}</@td>
                        <@td>${firstNameAttr.value!"N/A"}</@td>
                        <@td>${attributeChanges[0].authorName!"N/A"}</@td>
                        <@td>${attributeChanges[0].authorType!"N/A"}</@td>
                        <@td>
                          <#list attributeChanges as attributeChange>
                            <@tag color="light">${getName(attributeChange.attributeKey)}</@tag>
                          </#list>
                        </@td>
                        <@td><@tag color="success" class="text-uppercase">#i18n{identitymediation.search_duplicates.status.merge}</@tag></@td>
                      </@tr>
                    </#list>
                  </#list>
                  </#if>
                </@table>
            </div>
          </div>
        </@tabs>
      </#if>
    </div>
  </@pageColumn>
</@pageContainer>