<style>
    #resolve-duplicate-table th {
        text-transform: uppercase;
    }
    button.arrow-button, button.x-button {
        min-height: 0;
        max-height: 0;
        max-width: 10px;
    }
    span.non-matching-value {
        font-weight: bold;
        color: red;
    }
</style>
<script type="text/javascript">
    $(function() {
        $('span[id^="main-"]').each(function() {
            let value = $(this).text().trim().toUpperCase();
            if (value) {
                let key = $(this).prop('id').replace('main-', '');
                $('span.'+key+'-value').each(function() {
                    if ($(this).text().trim().toUpperCase() !== value) {
                        $(this).addClass('non-matching-value');
                    }
                });
            }
        });

        $('button.arrow-button').click(function() {
            let key = $(this).data('key');
            let value = $(this).data('value');
            let certif = $(this).data('certif');
            let certifdate = $(this).data('certifdate');
            let certiftimestamp = $(this).data('timestamp-certif');
            $('input[name="override-' + key + '"]').val(value).prop("disabled", false);
            $('input[name="override-' + key + '-certif"]').val(certif).prop("disabled", false);
            $('input[name="override-' + key + '-timestamp-certif"]').val(certiftimestamp).prop("disabled", false);

            // Hide all arrows on this line.
            $(this).parents('tr').children('td').children('button.arrow-button').hide();

            $('td#' + key + '-main-td').append($('<div id="override-' + key + '-badge" class="badge bg-success" />'));
            $('div#override-' + key + '-badge').append($('<span/>').html(value))
                                               .append($('<span class="badge rounded-pill mx-1"/>').html(certif))
                                               .append($('<span class="certification-date"/>').html(certifdate))
                                               // X button
                                               .append($('<button class="btn btn-danger ms-1 x-button"/>').html('<i class="ti ti-x" aria-hidden="true"></i>').click(function(){
                                                   $('input[name="override-' + key + '"]').val('').prop("disabled", true);
                                                   $('input[name="override-' + key + '-certif"]').val('').prop("disabled", true);
                                                   $('input[name="override-' + key + '-timestamp-certif"]').val('').prop("disabled", true);
                                                   // Show the arrows again
                                                   $(this).parents('tr').children('td').children('button.arrow-button').show();
                                                   // Remove the fetched attribute value
                                                   $('td#' + key + '-main-td').empty();
                                               }));
        });
    });
</script>

<form class="form-inline" action="jsp/admin/plugins/identitymediation/IdentityDuplicate.jsp">
    <@rowBox>
        <@boxHeader i18nTitleKey="identitymediation.resolve_duplicates.title">
            <@headerButtons>
            </@headerButtons>
        </@boxHeader>
        <@boxBody>
            <@messages infos=infos />
            <@messages errors=errors />
            <@messages warnings=warnings />

            <#if service_contract??>
                <@table id="resolve-duplicate-table">
                    <tr>
                        <th style="width: 400px;">&nbsp;</th>
                        <th style="width: 500px;">
                            <div class="col-12">#i18n{identitymediation.resolve_duplicates.identityToKeep}</div>
                            <span class="quality-span">${identity_to_keep.quality}</span> %
                        </th>
                        <th style="width: 300px;"><@button buttonIcon='arrows-left-right' type='submit' name="action_swapIdentities"/></th>
                        <th class="fw-normal">
                            <div class="col-12">#i18n{identitymediation.resolve_duplicates.identityToMerge}</div>
                            <span class="quality-span">${identity_to_merge.quality}</span> %
                        </th>
                    </tr>
                    <@tableHeadBodySeparator />
                    <#list service_contract.attributeDefinitions?filter(a -> a.attributeRight.readable) as readableAttr>
                        <tr>
                            <td>${readableAttr.name}</td>
                            <input type="hidden" name="override-${readableAttr.keyName}" disabled>
                            <input type="hidden" name="override-${readableAttr.keyName}-certif" disabled>
                            <input type="hidden" name="override-${readableAttr.keyName}-timestamp-certif" disabled>
                            <td id="${readableAttr.keyName}-main-td">
                                <#list identity_to_keep.attributes?filter(a -> a.key == readableAttr.keyName) as attr>
                                    <span id="main-${attr.key}" class="fw-bold">${attr.value}</span>
                                    <#if attr.certifier??>
                                        <span class="badge rounded-pill bg-info mx-1">${attr.certifier}</span>
                                    </#if>
                                    <#if attr.certificationDate??>
                                        <span class="certification-date">${attr.certificationDate?date}</span>
                                    </#if>
                                </#list>
                            </td>
                            <td></td>
                            <td>
                                <#list identity_to_merge.attributes?filter(a -> a.key == readableAttr.keyName) as attr>
                                    <#if identity_to_keep.attributes?filter(a -> a.key == readableAttr.keyName)?size == 0 && readableAttr.attributeRight.writable >
                                        <@button class='arrow-button' buttonIcon='arrow-left' params='data-key="${attr.key}" data-value="${attr.value}" data-certif="${attr.certifier}" data-certifdate="${attr.certificationDate?date}" data-timestamp-certif="${attr.certificationDate?long}"' />
                                    </#if>
                                    <span class="${attr.key}-value">${attr.value}</span>
                                    <#if attr.certifier??>
                                        <span class="badge rounded-pill bg-info mx-1">${attr.certifier}</span>
                                    </#if>
                                    <#if attr.certificationDate??>
                                        <span class="certification-date">${attr.certificationDate?date}</span>
                                    </#if>
                                </#list>
                            </td>
                        </tr>
                    </#list>
                </@table>
            </#if>
        </@boxBody>
    </@rowBox>
    <@rowBox boxClass="action-box">
        <@boxBody>
            <button id="merge-btn" class="btn btn-warning" name="action_mergeDuplicate" >
                #i18n{identitymediation.resolve_duplicates.buttonMergeDuplicate}
            </button>
            <button id="exclude-btn" class="btn btn-warning" name="action_excludeDuplicate" >
                #i18n{identitymediation.resolve_duplicates.buttonExcludeDuplicate}
            </button>
        </@boxBody>
    </@rowBox>
</form>