<style>
    #resolve-duplicate-table th {
        text-transform: uppercase;
    }
    button.arrow-button, button.x-button {
        min-height: 0;
        max-height: 0;
        max-width: 10px;
    }
</style>
<script type="text/javascript">
    $(function() {
        if ($('input[name="duplicate-id"]').val()) {
            $('div.action-box').show();
        } else {
            $('div.action-box').hide();
        }

        $('button.select-identity-btn').click(function() {
            $('input[name="duplicate-id"]').val($(this).data('cuid'));
            $('div.action-box').show();
        });

        $('button.arrow-button').click(function() {
            let key = $(this).data('key');
            let value = $(this).data('value');
            let certif = $(this).data('certif');
            let certifdate = $(this).data('certifdate');
            let certiftimestamp = $(this).data('certiftimestamp');
            $('input[name="override-' + key + '"]').val(value).prop("disabled", false);
            $('input[name="override-' + key + '-certif"]').val(certif).prop("disabled", false);
            $('input[name="override-' + key + '-certiftimestamp"]').val(certiftimestamp).prop("disabled", false);

            $(this).parents('tr').children('td').children('button.arrow-button').hide();

            $('td#' + key + '-main-td').append($('<div id="override-' + key + '-badge" class="badge bg-success" />'));
            $('div#override-' + key + '-badge').append($('<span/>').html(value))
                                               .append($('<span class="badge rounded-pill mx-1"/>').html(certif))
                                               .append($('<span class="certification-date"/>').html(certifdate))
                                               .append($('<button class="btn btn-danger ms-1 x-button"/>').html('<i class="ti ti-x" aria-hidden="true"></i>').click(function(){
                                                   $('input[name="override-' + key + '"]').val('').prop("disabled", true);
                                                   $('input[name="override-' + key + '-certif"]').val('').prop("disabled", true);
                                                   $('input[name="override-' + key + '-certiftimestamp"]').val('').prop("disabled", true);
                                                   $(this).parents('tr').children('td').children('button.arrow-button').show();
                                                   $('td#' + key + '-main-td').empty();
                                               }));
        });
    });
</script>

<form class="form-inline" action="jsp/admin/plugins/identitymediation/IdentityDuplicate.jsp">
    <input type="hidden" name="customer-id" value="${identity.customerId}">
    <input type="hidden" name="connection-id" value="${identity.connectionId}">
    <@rowBox>
        <@boxHeader i18nTitleKey="identitymediation.resolve_duplicates.title">
            <@headerButtons>
            </@headerButtons>
        </@boxHeader>
        <@boxBody>
            <@messages infos=infos />
            <@messages errors=errors />
            <@messages warnings=warnings />

            <#if service_contract??>
                <@table id="resolve-duplicate-table">
                    <tr>
                        <th>&nbsp;</th>
                        <th>
                            <div class="col-12">#i18n{identitymediation.resolve_duplicates.identityToKeep}</div>
                            <span class="quality-span">${identity.quality}</span> %
                        </th>
                        <#list potential_duplicate_list as duplicate>
                            <th class="fw-normal">
                                <div class="col-12">#i18n{identitymediation.resolve_duplicates.identityToMerge}</div>
                                <span class="quality-span">${duplicate.quality}</span> %
                            </th>
                        </#list>
                    </tr>
                    <@tableHeadBodySeparator />
                    <#list service_contract.attributeDefinitions?filter(a -> a.attributeRight.readable) as readableAttr>
                        <tr>
                            <td>${readableAttr.name}</td>
                            <input type="hidden" name="override-${readableAttr.keyName}" disabled>
                            <input type="hidden" name="override-${readableAttr.keyName}-certif" disabled>
                            <input type="hidden" name="override-${readableAttr.keyName}-certiftimestamp" disabled>
                            <td id="${readableAttr.keyName}-main-td">
                                <#list identity.attributes?filter(a -> a.key == readableAttr.keyName) as attr>
                                    <span id="main-${attr.key}" class="fw-bold">${attr.value}</span>
                                    <#if attr.certifier??>
                                        <span class="badge rounded-pill bg-info mx-1">${attr.certifier}</span>
                                    </#if>
                                    <#if attr.certificationDate??>
                                        <span class="certification-date">${attr.certificationDate?date}</span>
                                    </#if>
                                </#list>
                            </td>
                            <#list potential_duplicate_list as duplicate>
                                <td>
                                    <#list duplicate.attributes?filter(a -> a.key == readableAttr.keyName) as attr>
                                        <#if identity.attributes?filter(a -> a.key == readableAttr.keyName)?size == 0 && readableAttr.attributeRight.writable >
                                            <@button class='arrow-button' buttonIcon='arrow-left' params='data-key="${attr.key}" data-value="${attr.value}" data-certif="${attr.certifier}" data-certifdate="${attr.certificationDate?date}" data-certiftimestamp="${attr.certificationDate?long}"' />
                                        </#if>
                                        <span class="${attr.key}-value">${attr.value}</span>
                                        <#if attr.certifier??>
                                            <span class="badge rounded-pill bg-info mx-1">${attr.certifier}</span>
                                        </#if>
                                        <#if attr.certificationDate??>
                                            <span class="certification-date">${attr.certificationDate?date}</span>
                                        </#if>
                                    </#list>
                                </td>
                            </#list>
                        </tr>
                    </#list>
                    <#if potential_duplicate_list?size gt 1>
                        <tr>
                            <td>&nbsp;</td>
                            <td>&nbsp;</td>
                            <#list potential_duplicate_list as duplicate>
                                <td>
                                    <button type="button" class="btn btn-outline-warning action-btn select-identity-btn" data-cuid="${duplicate.customerId}">
                                        #i18n{identitymediation.resolve_duplicates.buttonSelectIdentity}
                                    </button>
                                </td>
                            </#list>
                        </tr>
                        <input type="hidden" name="duplicate-id">
                    <#else>
                        <input type="hidden" name="duplicate-id" value="<#list potential_duplicate_list as duplicate>${duplicate.customerId}</#list>">
                    </#if>
                </@table>
            </#if>
        </@boxBody>
    </@rowBox>
    <@rowBox boxClass="action-box">
        <@boxBody>
            <button id="merge-btn" class="btn btn-warning" name="action_mergeDuplicate" >
                #i18n{identitymediation.resolve_duplicates.buttonMergeDuplicate}
            </button>
            <button id="exclude-btn" class="btn btn-warning" name="action_excludeDuplicate" >
                #i18n{identitymediation.resolve_duplicates.buttonExcludeDuplicate}
            </button>
        </@boxBody>
    </@rowBox>
</form>